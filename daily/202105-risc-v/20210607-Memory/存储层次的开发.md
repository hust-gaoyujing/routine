



### 存储层次的开发



#### 1. 简介

两个重要的局部性原理：

时间局部性：最近被访问的数据在接下来很有可能还会被访问；

空间局部性：某个数据被访问后，他周围的数据还有会很快被访问；



存储器层次结构：一种多存储器层次组成的结构，存储器的容量和访问速度随着离处理器距离的增加而增加；

一个存储器层次结构可以由多层构成，但是数据每次只会在相邻的两个层次间传输；



#### 2. 存储器层次结构

四种技术：SRAM,DRAM,FLASH,磁盘

![image-20210609092005406](存储层次的开发.assets/image-20210609092005406.png)

SRAM:一种组织成存储阵列结构的简单集成电路，一个基本存储单元通常与6-8个晶体管组成。

![SRAM六管结构的工作原理](存储层次的开发.assets/o4YBAF8OxVSAXT1dAABm9SOjGj4912.png)

SRAM基本单元由两个CMOS反相器组成。两个反相器的输入、输出交叉连接，即第一个反相器的输出连接第二个反相器的输入，第二个反相器的输出连接第一个反相器的输入。这实现了两个反相器的输出状态的锁定、保存，即存储了1个位元的状态。



DRAM：使用电容保存电荷的方式来存储数据，通过一个晶体管实现对该电容的访问；比SRAM密度高得多，但是不能长久的存储数据，需要周期性的刷新电容（称为动态的原因）。刷新方式常见三种：

- 集中刷新
- 分散刷新
- 异步刷新

[DRAM 原理 1 ：DRAM Storage Cell](http://www.wowotech.net/basic_tech/307.html)

[DRAM 原理 2 ：DRAM Memory Organization](http://www.wowotech.net/basic_tech/309.html)

[DRAM 原理 3 ：DRAM Device](http://www.wowotech.net/basic_tech/321.html)

[DRAM 原理 4 ：DRAM Timing (wowotech.net)](http://www.wowotech.net/basic_tech/330.html)

[DRAM 原理 5 ：DRAM Devices Organization](http://www.wowotech.net/basic_tech/343.html)



FLASH: 一种电可擦除可编程只读存储器，采用损耗均衡技术（控制器将写入很多次的块映射到写入次数较少的块中）。优点在于可以在不加电的情况下长期保持存储的信息，既有ROM的特点，又有很高的存储速度，而且易于擦除和重写，功耗很小。

[嵌入式系统存储（RAM、ROM、Flash）_嵌入式-CSDN博客_嵌入式flash](https://blog.csdn.net/weixin_42653531/article/details/90745042)

[NAND闪存与NOR闪存的工作原理详解_sunflowerfsw的博客-CSDN博客_nand nor](https://blog.csdn.net/sunflowerfsw/article/details/52278792)



磁盘：



#### 3. Caches的基本原理

##### 3.1 直接映射：

![image-20210609163831958](存储层次的开发.assets/image-20210609163831958.png)

- 假设Cache每行存储32个bit，即4个bytes，则地址的低两位作为byte offset来对齐地址；

- 根据Cache的索引大小选择相应的地址段作为索引，比如cache索引1024，则将地址的[11:2]作为索引，指向0~1023；
- 地址的其余位作为标签，当地址对应的memory内容被读到cache中data段，地址的[63,12]也被写入tag段，同时valid置位；

##### 3.2 cache缺失处理

如果cache命中，计算机继续使用该数据，没有其他的额外开销；但是当未命中时，cache就需要增加一些额外的工作，处理过程主要由两个部分完成：处理器控制单元，以及一个初始化主存访问和重新填充cache的独立控制器；

出现缺失时，乱序执行的处理器比顺序执行的处理器处理方法要复杂的多，这里介绍顺序执行的情况：

- PC-4送到存储器中；
- 通知主存执行一次读操作，并等待访问完成；
- 写cache（data、tag、valid)
- 重启指令执行第一步，重新取值；

##### 3.3 写操作处理

写直达：避免内存与cache的内容不一致，直接同时向memory和cache中写数据；使用写直达的机制每次写操作都要把数据写入主存，花费大量的时间。

写缓冲：将数据写入cache和缓冲器后CPU可以继续执行其他的指令，然后缓冲器向mem中写入，在缓冲器满了的时候，CPU必须停顿下来，直接导致当写操作产生速度超过mem写入的速度，写缓冲就不起作用了；

写回：将数据写入cache，知道这块数据要被替代时才写入mem；



